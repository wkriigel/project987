# **View-from-CSV**

A concise, tech-stack-agnostic spec for turning a scraped CSV of **987.2 Cayman/Boxster** listings into a **ranked, scannable table** with a fair-value dollar model. This captures our finalized rules for **formatting, abbreviations, sorting, and pricing logic**, plus the **Options v2** catalog (codes \+ synonyms → compact labels \+ dollar weights).

---

## **1\) Purpose**

* Input: one or more **scraped CSVs** (e.g., from Cars.com via AutoTempest), and/or manual CSVs added to a folder.

* Output: a **terminal-style table** (or equivalent UI grid) ranked by **Deal Δ ($) \= Fair Value − Price**.

* Philosophy: simple, explainable, dollar-based model; quick visual scan; minimal knobs; robust to messy listing text.

---

## **2\) Columns & Ordering (View)**

**Order (left → right):**

1. **Deal Δ ($)** — positive means “undervalued.”

2. **Price** — rounded **up** to the nearest $1k, shown as `$29k`, `$33k`, etc.

3. **Miles** — rounded **up** to the nearest 1k, shown as `79k`, `36k`, etc.

4. **Year/Model/Trim** — `2010 Cayman S` or `2011 Boxster`; **do not** display the word “Base.”

5. **Transmission** — normalize `PDK/Automatic/Tiptronic` to **Automatic** in view; manual stays **Manual**.

6. **Colors (Ext / Int)** — e.g., `White / Tan`.

7. **Top Options** — compact labels joined by `,` (value-ordered).

8. **Source** — e.g., `cars.com`, `truecar`, etc.

**Display details:**

* **Missing values** for price/miles: show blank in the view (but use neutral assumptions for scoring; see §6).

* **String casing:** keep factory color names as scraped when reasonable (e.g., *Arctic Silver Metallic*).

* **No “(color/color)” annotations** in view.

---

## **3\) Input CSV Schema (minimum fields)**

Your scraper (or manual CSV) should aim to provide:

| Field | Type | Notes |
| ----- | ----- | ----- |
| `timestamp_run_id` | string | Any run/session ID you use. |
| `source` | string | `cars.com`, `carvana`, etc. |
| `listing_url` | string | Canonical detail URL. |
| `vin` | string? | Preferred for dedupe. |
| `year` | int? | 2009–2012 for 987.2. |
| `model` | string | `Cayman` or `Boxster`. |
| `trim` | string? | e.g., `S`, `R`, `Black Edition`. Leave blank for base. |
| `transmission_raw` | string? | Raw string (“7-Speed PDK”, etc.). |
| `price_usd` | int? | Numeric dollar price (no symbols). |
| `mileage` | int? | Odometer miles. |
| `exterior_color` | string? | As scraped. |
| `interior_color` | string? | As scraped. |
| `raw_options` | list/string | Curated lines from the page that mention options/features. |
| `location` | string? | City/State as shown on listing. |

The pipeline will derive additional fields (transmission normalization, color buckets, options, fair value, etc.).

---

## **4\) Normalization Rules**

### **4.1 Transmission**

* If `transmission_raw` matches **PDK**, **Automatic**, or **Tiptronic** → **Automatic** (category).

* Else if it matches **Manual** → **Manual**.

* Display exactly **Automatic** or **Manual**.

### **4.2 Colors → Buckets (for value)**

* **Monochrome:** `white`, `black`, `gray`, `silver` (case/variant tolerant).

* **Color:** everything else.

* Keep the original color names for display; use buckets only for value bonuses.

### **4.3 Model/Trim (display)**

* Combine **Year**, **Model**, **Trim** as `YYYY Model Trim`.

* If trim is blank or `Base` → **omit** trim.

---

## **5\) Options v2 (codes \+ synonyms → compact labels \+ value)**

We detect options from `raw_options` text using case-insensitive regexes and known synonyms. We store codes for traceability and show **compact labels** in value order.

**Default catalog (editable):**

| ID | Display | Value ($) | Notes & Synonyms (examples) |
| ----- | ----- | ----- | ----- |
| `220` | LSD | 1200 | `limited-slip`, `LSD`, locking/self-locking diff |
| `639`/`640` | chrono | 1000 | `Sport Chrono`, `Chrono (Plus/Package)` |
| `XLF` | exhaust | 800 | `PSE`, `Sport Exhaust`, `Switchable exhaust` |
| `PASM`(`475`) | PASM | 800 | `PASM`, adaptive/active suspension |
| `19W` | 19" wheels | 400 | `19"`, `235/35R19`, `265/35R19` (not credited if standard on trim) |
| `680` | BOSE | 300 | `BOSE` |
| `PCM` | PCM/Nav | 300 | `PCM`, `navigation`, `nav system` |
| `BIX` (`601/603`) | Bi-Xenon | 250 | `bi-xenon`, `Litronic`, `cornering lights` |
| `HTD` | heated seats | 150 | `heated seats`, `seat heating` |
| `CLD` | cooled seats | 150 | `cooled seats`, `ventilated seats` |
| `SSEAT` (`P01`\*) | sport seats | 500 | `sport seats`, `adaptive sport seats`, `bucket/shell seats` |
| `250` | PDK | 0 | Stored (987.2 auto implies PDK), **not shown** in Top Options |

\*Codes vary by year/market; we rely on synonyms primarily.

**Standard-on suppression:**  
 Don’t credit options that are **standard on the trim** (e.g., **Cayman R**: no credit for `LSD` or `19" wheels`). Keep a trim list for suppression (editable).

**Top Options (view):** show detected labels in **descending value** order (e.g., `LSD, chrono, exhaust, PASM, …`). No limit enforced by default.

---

## **6\) Fair-Value Model (all dollars)**

We compute a **fair value** per car, then the **deal delta**:

Fair Value ($) \= Base \+ Trim Premium \+ Year Step \+ Mileage Bonus \+ Color Bonus \+ Options Total  
Deal Δ ($)     \= Fair Value ($) − Asking Price ($)

**Defaults (editable)**

* **Base** (2009 Base, Automatic, 60–79k miles, mono/mono, no options): **$30,500**

* **Trim Premiums:**

  * Base: **$0**

  * **S: $7,000**

  * **R: $30,000**

  * **Black Edition: $1,500**

  * **Boxster Spyder: $30,000**

* **Year Step:** \+**$500** per year from 2009\.

* **Mileage Bands → Bonus:**

  * `<40k`: **\+3000**

  * `40–59k`: **\+1500**

  * `60–79k`: **\+0**

  * `80–99k`: **−4000**

  * `>=100k`: **−15000**

  * If mileage missing → use **60–79k** (neutral) **for processing only**; leave view blank.

* **Color Bonus:**

  * Interior **color**: **\+$300** (tunable; personal preference can be **$500**)

  * Exterior **color**: **\+$300**

  * (Mono adds $0)

* **Options Total:** sum of **Options v2** values detected (after standard-on suppression).  
   *(If Options v2 is disabled, fallback is `top5_count × $600`.)*

**Example (explainable math in English):**  
 “2010 Cayman, Auto, 53k, White/Tan, heated seats”

* Base 30,500

* Trim (Base): \+0

* Year step: \+(2010−2009)×500 \= \+500

* Mileage: `40–59k` → \+1500

* Color: ext mono \+ int color(300) → \+300

* Options: heated seats(150) → \+150  
   **Fair Value \= 30,500 \+ 0 \+ 500 \+ 1,500 \+ 300 \+ 150 \= 32,950**  
   If price is $30,000 → **Deal Δ \= \+2,950**

---

## **7\) Sorting & Grouping**

1. **Transmission group first:** **Automatic** rows at the top; **Manual** rows at the bottom (even if their deltas are higher).  
    *Rationale: you’re PDK-first; manuals are reference/bargain intel, not primary candidates.*

2. Within each group:

   * Sort by **Deal Δ ($)** **descending** (best deals first),

   * Tie-break by **Price** **ascending**.

---

## **8\) Dedupe**

* Primary key: **VIN**.

* If VIN missing, you may (optionally) fall back to **exact mileage \+ URL** match; do **not** merge on fuzzy data.

* Prefer the row with **more complete fields** (if a collision occurs).

---

## **9\) Abbreviations & Formatting**

* **Price**: round **up** to nearest $1,000 → `$31k`, `$24k`.

* **Miles**: round **up** to nearest 1,000 → `61k`, `36k`.

* **Deal Δ**: signed number with no thousands separator (table alignment) or use `$` if desired; e.g., `+2801`, `-8373`.  
   Optional: show with `$` → `+$2,801`, `-$8,373` (consistent across app).

* **No fake data** in view: blanks remain blank. (We only use neutral assumptions to keep them ranked for you to research.)

---

## **10\) Optional Colorization (UI polish)**

*(You can implement now or keep as a planned enhancement.)*

* **Deal Δ ($):**

  * `> +$5,000` → strong green

  * `+$1,000 to +$5,000` → green

  * `-$1,000 to +$1,000` → neutral

  * `< -$1,000` → red

* **Transmission:** dim the Manual section header or insert a soft divider.

* **Color buckets:** optionally tint the `Colors (Ext / Int)` cell if **both** are color (your “interior wins” preference can be reflected with a slightly stronger tint for colored interiors).

---

## **11\) Configuration (suggested keys & defaults)**

\[dev\]  
\# Whether to read the latest normalized CSV (no scraping) when iterating on scoring/view:  
use\_cached\_normalized \= true

\[fair\_value\]  
base\_value\_usd \= 30500  
year\_step\_usd \= 500  
mileage\_band\_bonus\_usd \= { "\<40k"=3000, "40-59k"=1500, "60-79k"=0, "80-99k"=-4000, "\>=100k"=-15000 }  
interior\_color\_color\_usd \= 300   \# set 500 if you want stronger interior preference  
exterior\_color\_color\_usd \= 300  
trim\_premiums \= { Base=0, S=7000, R=30000, "Black Edition"=1500, "Boxster Spyder"=30000 }

\[options\_v2\]  
enabled \= true  
\# (Catalog as in §5; editable values/synonyms/standard\_on)

---

## **12\) Edge Cases**

* **Missing price or mileage:** include the row in ranking (neutral band for miles, no price → no Δ). Show blanks in view.

* **Listings with sparse text:** options detection will be conservative; we only credit what we can reliably match.

* **Trims in odd places:** we check both `model` and `trim` fields (case-insensitive contains) to infer premiums and standard-on suppression.

---

## **13\) Example Row (before/after)**

**Raw:**  
 `year=2011, model=Boxster, trim=S, transmission_raw='7-Speed PDK', price_usd=27000, mileage=34000, colors='Silver/Black', raw_options='Heated seats; PCM'`

**Derived:**

* Transmission → **Automatic**

* Color buckets → ext mono, int mono → \+$0

* Options → `heated seats (150)`, `PCM/Nav (300)` → \+$450

* Fair value → `30500 + 7000 + (2011-2009)*500 + <40k(3000) + 0 + 450 = 41,950`

* Deal Δ → `41,950 - 27,000 = +14,950`

* View:  
   `+14950 | $27k | 34k | 2011 Boxster S | Automatic | Silver / Black | PCM/Nav, heated seats | cars.com`

---

## **14\) Development Notes (non-binding)**

* Keep the options catalog **data-driven** (codes, synonyms, values, standard\_on) so you can tune without code changes.

* Always sort options by **value desc** in display to surface the stuff you care about first.

* Keep normalization small & explainable; this doc should be enough to re-implement in any stack.

---

## **15\) Success Criteria**

* From a single CSV, the table **ranks** cars so your top three **PDK** picks emerge immediately.

* Manual cars appear **below** automatics, still ranked by Δ for reference.

* Adjusting a handful of config numbers (e.g., interior color bonus) updates rankings **predictably**.

* The table is **readable at a glance** (rounded price/miles, compact option labels, clean column order).

---

